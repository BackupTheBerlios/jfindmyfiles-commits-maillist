<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Jfindmyfiles-commits] r139 - in trunk/project/JFindMyFiles:	Catalog/src/de/berlios/jfindmyfiles/catalog/entities	JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs	ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/jfindmyfiles-commits/2008-June/index.html" >
   <LINK REL="made" HREF="mailto:jfindmyfiles-commits%40lists.berlios.de?Subject=Re%3A%20%5BJfindmyfiles-commits%5D%20r139%20-%20in%20trunk/project/JFindMyFiles%3A%0A%09Catalog/src/de/berlios/jfindmyfiles/catalog/entities%0A%09JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs%0A%09ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles&In-Reply-To=%3C200806101754.m5AHsiww017339%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000133.html">
   <LINK REL="Next"  HREF="000135.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Jfindmyfiles-commits] r139 - in trunk/project/JFindMyFiles:	Catalog/src/de/berlios/jfindmyfiles/catalog/entities	JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs	ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles</H1>
    <B>knitter at mail.berlios.de</B> 
    <A HREF="mailto:jfindmyfiles-commits%40lists.berlios.de?Subject=Re%3A%20%5BJfindmyfiles-commits%5D%20r139%20-%20in%20trunk/project/JFindMyFiles%3A%0A%09Catalog/src/de/berlios/jfindmyfiles/catalog/entities%0A%09JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs%0A%09ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles&In-Reply-To=%3C200806101754.m5AHsiww017339%40sheep.berlios.de%3E"
       TITLE="[Jfindmyfiles-commits] r139 - in trunk/project/JFindMyFiles:	Catalog/src/de/berlios/jfindmyfiles/catalog/entities	JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs	ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles">knitter at mail.berlios.de
       </A><BR>
    <I>Tue Jun 10 19:54:44 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000133.html">[Jfindmyfiles-commits] r138 - in trunk: media/icons/x16	project/JFindMyFiles/JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs	project/JFindMyFiles/JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/resources/images/x16	project/JFindMyFiles/ReadingFiles/nbproject	project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles
</A></li>
        <LI>Next message: <A HREF="000135.html">[Jfindmyfiles-commits] r140 - in trunk: docs	project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog	project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/entities	project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/entitymanagers	project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/utils	project/JFindMyFiles/JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs	project/JFindMyFiles/ReadingFiles/src/META-INF/services	project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles	project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles/utils
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#134">[ date ]</a>
              <a href="thread.html#134">[ thread ]</a>
              <a href="subject.html#134">[ subject ]</a>
              <a href="author.html#134">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: knitter
Date: 2008-06-10 19:54:28 +0200 (Tue, 10 Jun 2008)
New Revision: 139

Added:
   trunk/project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles/CompositeFile.java
Modified:
   trunk/project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/entities/FileWrapper.hbm.xml
   trunk/project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/entities/FileWrapper.java
   trunk/project/JFindMyFiles/JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs/NewDiskDlg.java
   trunk/project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles/MediaReader.java
Log:
Altera?\195?\167?\195?\181es ao algoritmo de leitura de ficheiros para incluir o sistema de hashing que permita identificar ficheiros iguais.

Modified: trunk/project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/entities/FileWrapper.hbm.xml
===================================================================
--- trunk/project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/entities/FileWrapper.hbm.xml	2008-06-10 16:43:56 UTC (rev 138)
+++ trunk/project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/entities/FileWrapper.hbm.xml	2008-06-10 17:54:28 UTC (rev 139)
@@ -35,6 +35,7 @@
         &lt;property name=&quot;hidden&quot;/&gt;
         &lt;property name=&quot;size&quot;/&gt;
         &lt;property name=&quot;extension&quot;/&gt;
+        &lt;property name=&quot;hash&quot;/&gt;
 
         &lt;property name=&quot;file&quot;/&gt;
         &lt;property name=&quot;folder&quot;/&gt;

Modified: trunk/project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/entities/FileWrapper.java
===================================================================
--- trunk/project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/entities/FileWrapper.java	2008-06-10 16:43:56 UTC (rev 138)
+++ trunk/project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/entities/FileWrapper.java	2008-06-10 17:54:28 UTC (rev 139)
@@ -40,6 +40,7 @@
     private ImageData image;
     private VideoData video;
     private AudioData audio;
+    private String hash;
     //Helpers    
     private boolean file;
     private boolean folder;
@@ -65,7 +66,7 @@
      */
     public FileWrapper(String name, String absolutePath, long size,
             boolean file, boolean hidden, long lastModified, Media disk,
-            FileWrapper parent) {
+            FileWrapper parent, String hash) {
         this.name = name;
         this.absolutePath = absolutePath;
         this.size = size;
@@ -74,6 +75,7 @@
         this.lastModified = lastModified;
         this.disk = disk;
         this.parent = parent;
+        this.hash = hash;
     }
 
     /**
@@ -147,6 +149,14 @@
     public void setExtension(String extension) {
         this.extension = extension;
     }
+    
+    public String getHash() {
+        return hash;
+    }
+    
+    public void setHash(String hash) {
+        this.hash = hash;
+    }
 
     public boolean isFile() {
         return file;

Modified: trunk/project/JFindMyFiles/JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs/NewDiskDlg.java
===================================================================
--- trunk/project/JFindMyFiles/JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs/NewDiskDlg.java	2008-06-10 16:43:56 UTC (rev 138)
+++ trunk/project/JFindMyFiles/JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs/NewDiskDlg.java	2008-06-10 17:54:28 UTC (rev 139)
@@ -362,7 +362,7 @@
 private void jbtnScanActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbtnScanActionPerformed
     MediaReader r = Lookup.getDefault().lookup(MediaReader.class);
     r.addListener(scanningDlg);
-    r.read(new File(currentSelectedPath), calculateHash, isMedia);
+    r.read(new File(currentSelectedPath), calculateHash, isMedia, jtfDiskName.getName().trim());
     
 }//GEN-LAST:event_jbtnScanActionPerformed
 

Added: trunk/project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles/CompositeFile.java
===================================================================
--- trunk/project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles/CompositeFile.java	2008-06-10 16:43:56 UTC (rev 138)
+++ trunk/project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles/CompositeFile.java	2008-06-10 17:54:28 UTC (rev 139)
@@ -0,0 +1,25 @@
+/*
+ * To change this template, choose Tools | Templates
+ * and open the template in the editor.
+ */
+
+package de.berlios.jfindmyfiles.readingfiles;
+
+import de.berlios.jfindmyfiles.catalog.entities.FileWrapper;
+import java.io.File;
+
+/**
+ *
+ * @author Knitter
+ */
+public class CompositeFile {
+    
+    public final File file;
+    public final FileWrapper parent;
+    
+    public CompositeFile(File file, FileWrapper parent) {
+        this.file = file;
+        this.parent = parent;                
+    }
+
+}

Modified: trunk/project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles/MediaReader.java
===================================================================
--- trunk/project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles/MediaReader.java	2008-06-10 16:43:56 UTC (rev 138)
+++ trunk/project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles/MediaReader.java	2008-06-10 17:54:28 UTC (rev 139)
@@ -8,8 +8,12 @@
 import de.berlios.jfindmyfiles.catalog.entities.FileWrapper;
 import de.berlios.jfindmyfiles.catalog.entities.Media;
 import java.io.File;
+import java.io.IOException;
+import java.security.NoSuchAlgorithmException;
 import java.util.Stack;
 import java.util.Vector;
+import jonelo.jacksum.JacksumAPI;
+import jonelo.jacksum.algorithm.AbstractChecksum;
 import org.hibernate.Session;
 import org.openide.util.Lookup;
 
@@ -27,7 +31,7 @@
         listeners = new Vector&lt;ReadingListener&gt;();
     }
 
-    public void read(final File file, final boolean sha, final boolean isMedia) {
+    public void read(final File file, final boolean sha, final boolean isMedia, String mediaName) {
 
         new Thread(new Runnable() {
 
@@ -35,72 +39,87 @@
                 fireReadingStarted(new ReadingEvent(me, &quot;&quot;, null));
                 Session s = Lookup.getDefault().lookup(CatalogEngine.class).sessionFactory.getCurrentSession();
                 s.beginTransaction();
-                Stack&lt;File&gt; directories = new Stack&lt;File&gt;();
+                Stack&lt;CompositeFile&gt; directories = new Stack&lt;CompositeFile&gt;();
                 File current, listing[];
-                long totalSize = 0L, childSize = 0L;
-                FileWrapper fw, child;
+                CompositeFile cf;
+                long childSize = 0L, totalSize = 0L;
+                FileWrapper fw, temp;
                 int z;
-                Media container = null;
-                if (isMedia) {
-                    container = new Media();
+                Media container = new Media();
+                s.save(container);
+
+                if ((listing = file.listFiles()) != null) {
+                    for (z = listing.length; z-- &gt; 0;) {
+                        if (listing[z].isDirectory()) {
+                            directories.push(new CompositeFile(listing[z], null));
+                        } else {
+                            fireReadingFile(new ReadingEvent(me, listing[z].getAbsolutePath(), null));
+                            totalSize += listing[z].length();
+                            temp = new FileWrapper(listing[z].getName(),
+                                    listing[z].getAbsolutePath(),
+                                    listing[z].length(), listing[z].isFile(),
+                                    listing[z].isHidden(),
+                                    listing[z].lastModified(), container, null,
+                                    (sha ? calculateSHA1HashString(listing[z]) : &quot;&quot;));
+                            s.save(temp);
+                            container.addFile(temp);
+                        }
+                    }
                 }
 
-                if (file.isDirectory()) {//NOTE: this protections may be dropped
-                    fw = new FileWrapper(file.getName(),
-                            file.getAbsolutePath(), 0, file.isFile(), file.isHidden(),
-                            file.lastModified(), container, null);
-
-                    if ((listing = file.listFiles()) != null) {
+                while (!directories.empty() &amp;&amp; !abort) {
+                    cf = directories.pop();
+                    current = cf.file;
+                    childSize = 0;
+                    fw = new FileWrapper(current.getName(),
+                            current.getAbsolutePath(), 0, current.isFile(),
+                            current.isHidden(), current.lastModified(),
+                            container, cf.parent, &quot;&quot;);//NOTE: should we hash a directory?
+                    s.save(fw);
+                    if ((listing = current.listFiles()) != null) {
                         for (z = listing.length; z-- &gt; 0;) {
                             if (listing[z].isDirectory()) {
-                                directories.push(listing[z]);
+                                directories.push(new CompositeFile(listing[z], fw));
                             } else {
-                                totalSize += listing[z].length();
-                                fw.addChild(new FileWrapper(listing[z].getName(),
+                                fireReadingFile(new ReadingEvent(me, listing[z].getAbsolutePath(), null));
+                                childSize += listing[z].length();
+                                temp = new FileWrapper(listing[z].getName(),
                                         listing[z].getAbsolutePath(),
                                         listing[z].length(), listing[z].isFile(),
                                         listing[z].isHidden(),
-                                        listing[z].lastModified(), container, fw));
+                                        listing[z].lastModified(), container, fw, 
+                                        (sha ? calculateSHA1HashString(listing[z]) : &quot;&quot;));
+                                s.save(temp);
+                                fw.addChild(temp);
                             }
                         }
                     }
-
-                    while (!directories.empty() &amp;&amp; !abort) {
-                        current = directories.pop();
-                        childSize = 0;
-                        child = new FileWrapper(current.getName(),
-                                current.getAbsolutePath(), 0, current.isFile(),
-                                current.isHidden(), current.lastModified(),
-                                container, null);
-
-                        if ((listing = current.listFiles()) != null) {
-                            for (z = listing.length; z-- &gt; 0;) {
-                                if (listing[z].isDirectory()) {
-                                    directories.push(listing[z]);
-                                } else {
-                                    childSize += listing[z].length();
-                                    child.addChild(new FileWrapper(listing[z].getName(),
-                                            listing[z].getAbsolutePath(),
-                                            listing[z].length(), listing[z].isFile(),
-                                            listing[z].isHidden(),
-                                            listing[z].lastModified(), container, fw));
-                                }
-                            }
-                        }
-                        child.setSize(childSize);
-                    }
-                    fw.setSize(totalSize);
-                    if (abort) {
-                        s.getTransaction().rollback();
-                    }
-                    s.getTransaction().commit();
+                    fw.setSize(childSize);
+                    totalSize += childSize;
                 }
+                //TODO: capacity
+                if (abort) {
+                    s.getTransaction().rollback();
+                }
+                s.getTransaction().commit();
                 fireReadingStopped(new ReadingEvent(me, &quot;&quot;, container));
             }
         }).start();
 
     }
 
+    private String calculateSHA1HashString(File file) {
+        AbstractChecksum checksum = null;
+        try {
+            checksum = JacksumAPI.getChecksumInstance(&quot;sha-1&quot;);
+            return &quot;&quot; + checksum.readFile(file.getAbsolutePath());
+        } catch (IOException ex) {
+            return &quot;&quot;;
+        } catch (NoSuchAlgorithmException ex) {
+            return &quot;&quot;;
+        }
+    }
+
     public void abort() {
         abort = true;
         fireReadingAborted(new ReadingEvent(this, &quot;&quot;, null));
@@ -119,7 +138,7 @@
             listeners.remove(l);
         }
     }
-   
+
     private void fireReadingStarted(ReadingEvent evt) {
         for (ReadingListener l : listeners) {
             l.readingStarted(evt);
@@ -131,7 +150,7 @@
             l.readingStopped(evt);
         }
     }
-    
+
     private void fireReadingFile(ReadingEvent evt) {
         for (ReadingListener l : listeners) {
             l.readingFile(evt);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000133.html">[Jfindmyfiles-commits] r138 - in trunk: media/icons/x16	project/JFindMyFiles/JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs	project/JFindMyFiles/JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/resources/images/x16	project/JFindMyFiles/ReadingFiles/nbproject	project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles
</A></li>
	<LI>Next message: <A HREF="000135.html">[Jfindmyfiles-commits] r140 - in trunk: docs	project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog	project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/entities	project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/entitymanagers	project/JFindMyFiles/Catalog/src/de/berlios/jfindmyfiles/catalog/utils	project/JFindMyFiles/JFindMyFilesGui/src/de/berlios/jfindmyfiles/jfindmyfilesgui/dialogs	project/JFindMyFiles/ReadingFiles/src/META-INF/services	project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles	project/JFindMyFiles/ReadingFiles/src/de/berlios/jfindmyfiles/readingfiles/utils
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#134">[ date ]</a>
              <a href="thread.html#134">[ thread ]</a>
              <a href="subject.html#134">[ subject ]</a>
              <a href="author.html#134">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/jfindmyfiles-commits">More information about the Jfindmyfiles-commits
mailing list</a><br>
</body></html>
